(()=>{var e={376:e=>{"use strict";e.exports=require("axios")},479:e=>{"use strict";e.exports=require("cors")},334:e=>{"use strict";e.exports=require("dotenv")},127:e=>{"use strict";e.exports=require("express")},880:e=>{"use strict";e.exports=require("fast-jwt")},605:e=>{"use strict";e.exports=require("http")},722:e=>{"use strict";e.exports=require("jsonwebtoken")},531:e=>{"use strict";e.exports=require("orm")},395:e=>{"use strict";e.exports=require("socket.io")}},s={};function o(t){var n=s[t];if(void 0!==n)return n.exports;var r=s[t]={exports:{}};return e[t](r,r.exports,o),r.exports}(()=>{o(334).config();const e=o(479),s=o(722),{createSigner:t,createVerifier:n}=o(880),r=o(531),i=o(376),a=o(127),c=o(605),l=a(),u=c.createServer(l);o(395)(u),l.use(e()),l.use(a.json());const d=r.connect({host:"localhost",database:"webrtc-connect",user:"postgres",password:"From2006",protocol:"pg",port:"5432",query:{pool:!0,debug:!0}});let p;d.on("connect",(e=>{if(e)return console.error("Connection error: "+e);console.log("connected to db successfully"),p=d.define("user",{rules:String,email:String,password:String,nickname:String}),d.sync((e=>{if(e)throw e;p.find({nickname:"God Almighty"},((e,s)=>{console.log(s.length)}))}))}));let g={HOST:"http://192.168.0.13",httpPORT:":8088",socketPORT:":8188",home:"/janus",sessionID:"",pluginID:""},m={users:[{rules:"admin",email:"admin@ad.ad",password:"admin123",nickname:"God Almighty"},{rules:"user",email:"qwe@qwe.qwe",password:"qwe123qwe",nickname:"Qwerty"}],rooms:[{id:"1234",title:"shitpost!"},{id:"4321",title:"naruto - eto kruto"}],janus:{sessionID:-1}};l.get("/",(function(e,s){s.send("8001. Authorisation service")})),l.get("/api/rooms",((e,s,o)=>{console.log("token Check");const t=e.headers.authorization,r=t&&t.split(" ")[1];if(void 0===r)return void s.status(401).send();const i=n({key:process.env.ACCESS_TOKEN_SECRET});try{const s=i(r);console.log(s),e.user=s,o()}catch(e){return console.log(e),s.status(403).send(e)}}),((e,s)=>{console.log("get rooms"),s.status(200).send({rooms:m.rooms})})),l.get("/janus/connect",((e,s)=>{console.log("connect to Janus");const o=g;i.post(o.HOST+o.httpPORT+o.home,{janus:"create",transaction:""}).then((e=>{console.log("got sessionID"),o.sessionID="/"+e.data.data.id})).catch((e=>{console.log(e)})),s.status(200).send("connected to janus")})),l.post("/janus/attach-video",((e,s)=>{console.log("attach videoroom to Janus");const o=g;i.post(o.HOST+o.httpPORT+o.home+o.sessionID,{janus:"attach",transaction:"",plugin:"janus.plugin.videoroom"}).then((e=>{o.pluginID="/"+e.data.data.id,console.log("got pluginID")})).catch((e=>{console.log(e)})),s.status(200).send("videoroom plugin attached")})),l.post("/auth/login",((e,s)=>{const o={email:e.body.email,password:e.body.password};console.log(o),p.find({email:o.email},((e,n)=>{const r=n[0];if(r&&r.password===o.password){const e={email:r.email,nickname:r.nickname},o=t({key:process.env.ACCESS_TOKEN_SECRET})(e);s.status(200).send({accessToken:o})}s.status(403).send()}))})),l.post("/auth/register",((e,o)=>{const t={email:e.body.email,password:e.body.password,nickname:e.body.email.split("@")[0],rules:"user"};console.log(t),p.find({email:t.email},((e,n)=>{n.length>0&&o.status(400).send("user already exists"),p.create(t,(e=>{if(e)throw e;const n={email:t.email,nickname:t.nickname},r=s.sign(n,process.env.ACCESS_TOKEN_SECRET);o.status(200).send({accessToken:r})}))}))})),l.delete("/auth/logout",((e,s)=>{s.status(204).send("tokens refreshed")})),u.listen(8001,(()=>console.log("server running on port 8001")))})()})();